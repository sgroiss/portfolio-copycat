---
/// src/pages/projects/[slug].astro
import Layout from "../../layouts/Layout.astro";
import Project from "../../components/Project.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import MediaRenderer from "../../components/MediaRenderer.astro";

type ProjectEntry = CollectionEntry<"projects">;

// 1. Alle statischen Pfade für /projects/[slug] erzeugen
export async function getStaticPaths() {
  const projects = await getCollection<"projects">("projects");
  return projects.map((project) => ({
    params: { slug: project.slug },
  }));
}

// 2. Aktuellen Eintrag anhand des Slugs holen
const allProjects = await getCollection<"projects">("projects");
const { slug } = Astro.params;

// Projekte so sortieren wie auf der Startseite (nach "order")
const projects = allProjects
  .filter((entry) => entry.data.featured !== false)
  .sort((a, b) => (a.data.order ?? 999) - (b.data.order ?? 999));

const projectIndex = projects.findIndex((p) => p.slug === slug);

if (projectIndex === -1) {
  throw new Error(`Project not found for slug: ${slug}`);
}

const project = projects[projectIndex] as ProjectEntry;

// Nächstes & vorheriges Projekt im Loop berechnen
const nextIndex = (projectIndex + 1) % projects.length;
const prevIndex = (projectIndex - 1 + projects.length) % projects.length;

const nextProject = projects[nextIndex];
const prevProject = projects[prevIndex];

if (!project) {
  throw new Error(`Project not found for slug: ${slug}`);
}

const { Content } = await project.render();
---

<style>
  .next-project-teaser:hover {
    background-color: var(--next-overlay-color);
  }

  .prev-project-teaser:hover {
    background-color: var(--prev-overlay-color);
  }
</style>

<Layout title={`${project.data.title} – Simon Groiss`}>
  <main
    class="min-h-screen"
    data-project-slug={project.slug}
    data-project-index={projectIndex}
    data-project-total={projects.length}
  >
    <!-- Header / Intro -->
    <div
      id="project-header"
      class="md:h-[30vh] lg:h-[45vh] flex flex-col items-center justify-center"
    >
      <h1 class="text-6xl">{project.data.desc}</h1>
    </div>

    <!-- Entry-Overlay -->
    <div id="project-entry-container" class="relative h-[100px]">
      <div
        id="project-entry-static"
        class="h-[100px] flex items-center justify-center"
        style={`background-color: ${project.data.overlayColor};`}
      >
        <span class="text-lg uppercase">{project.data.title}</span>
      </div>
      <div
        id="project-entry-animation"
        class="fixed h-full inset-0 flex items-center justify-center z-50 pointer-events-none"
        style={`background-color: ${project.data.overlayColor};`}
      >
        <span id="project-title" class="text-lg uppercase opacity-0">
          {project.data.title}
        </span>
      </div>
    </div>

    <!-- CONTENT aus sections[] -->
    <section id="project-content">
      {
        project.data.sections?.map((section, index) => {
          // MEDIENBLOCK (ein Bild/Video)
          if (section.type === "media") {
            const baseClasses = section.fullwidth
              ? "w-full"
              : (section.class ?? "container mx-auto ");

            return (
              <div class={baseClasses} data-section-index={index}>
                <MediaRenderer
                  media={{
                    type: section.format,
                    src: section.src,
                    alt: section.alt,
                  }}
                  fallbackAlt={project.data.title}
                  class="w-full object-cover"
                />
              </div>
            );
          }

          // MEDIA-GROUP (z.B. 2 Bilder im Grid)
          if (section.type === "media-group") {
            const cols =
              section.layout === "3col" ? "grid-cols-3" : "grid-cols-2";
            const gap = section.gap ?? "gap-4";

            return (
              <div
                class={`container mx-auto grid ${cols} ${gap}`}
                data-section-index={index}
              >
                {section.items.map((item, itemIndex) => (
                  <MediaRenderer
                    media={{
                      type: item.format,
                      src: item.src,
                      alt: item.alt,
                    }}
                    fallbackAlt={project.data.title}
                    class={item.class ?? "w-full object-cover"}
                    data-item-index={itemIndex}
                  />
                ))}
              </div>
            );
          }

          // TEXTBLOCK
          if (section.type === "text") {
            return (
              <div
                class="container mx-auto px-[20vw]!"
                data-section-index={index}
              >
                <h2 class="text-4xl dm-sans font-normal mb-2">
                  {section.title}
                </h2>
                <p class="text-lg">{section.body}</p>
              </div>
            );
          }

          // SPACER
          if (section.type === "spacer") {
            const pad = section.size ?? "py-20";
            return <div class={pad} data-section-index={index} />;
          }

          return null;
        })
      }
    </section>
  </main>

  {
    projects.length > 1 && nextProject && prevProject && (
      <>
        <!-- Projekt-Navigation: links PREV, rechts NEXT -->
        <nav
          id="project-nav"
          class="grid grid-cols-2"
        >
          <!-- PREVIOUS PROJECT -->
          <a
            id="prev-project-link"
            href={`/projects/${prevProject.slug}`}
            class="block"
          >
            <div
              class="py-32 bg-sg-light-black flex items-center justify-center transition-colors duration-300 prev-project-teaser"
              style={`--prev-overlay-color: ${prevProject.data.overlayColor ?? "#ff0000"}`}
            >
              <span class="uppercase tracking-wide text-lg">
                Zum vorherigen Projekt:&nbsp;{prevProject.data.title}
              </span>
            </div>
          </a>

          <!-- NEXT PROJECT -->
          <a
            id="next-project-link"
            href={`/projects/${nextProject.slug}`}
            class="block"
          >
            <div
              class="py-32 bg-sg-light-black flex items-center justify-center transition-colors duration-300 next-project-teaser"
              style={`--next-overlay-color: ${nextProject.data.overlayColor ?? "#ff0000"}`}
            >
              <span class="uppercase tracking-wide text-lg">
                Zum nächsten Projekt:&nbsp;{nextProject.data.title}
              </span>
            </div>
          </a>
        </nav>

        <!-- Exit-/Entry-Overlay für Übergang zwischen Projekten -->
        <div
          id="project-exit-overlay"
          data-project-overlay-color={project.data.overlayColor}
          data-next-overlay-color={nextProject.data.overlayColor ?? "#ff0000"}
          data-prev-overlay-color={prevProject.data.overlayColor ?? "#ff0000"}
          data-next-slug={nextProject.slug}
          data-prev-slug={prevProject.slug}
          style="background-color: transparent;"
          class="fixed top-0 left-0 h-screen w-0 z-[9999] pointer-events-none"
        ></div>

      </>
    )
  }
</Layout>

<script>
  import "../../scripts/main.js";
  import "../../scripts/project-entry.js";
  import "../../scripts/project-exit.js";
</script>
