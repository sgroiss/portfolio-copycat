---
/// src/pages/projects/[slug].astro
import Layout from "../../layouts/Layout.astro";
import Project from "../../components/Project.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import MediaRenderer from "../../components/MediaRenderer.astro";

type ProjectEntry = CollectionEntry<"projects">;

// 1. Alle statischen Pfade für /projects/[slug] erzeugen
export async function getStaticPaths() {
  const projects = await getCollection<"projects">("projects");
  return projects.map((project) => ({
    params: { slug: project.slug },
  }));
}

// 2. Aktuellen Eintrag anhand des Slugs holen
const allProjects = await getCollection<"projects">("projects");
const { slug } = Astro.params;

// Projekte so sortieren wie auf der Startseite (nach "order")
const projects = allProjects
  .filter((entry) => entry.data.featured !== false)
  .sort((a, b) => (a.data.order ?? 999) - (b.data.order ?? 999));

const projectIndex = projects.findIndex((p) => p.slug === slug);

if (projectIndex === -1) {
  throw new Error(`Project not found for slug: ${slug}`);
}

const project = projects[projectIndex] as ProjectEntry;

// Nächstes Projekt im Loop berechnen
const nextIndex = (projectIndex + 1) % projects.length;
const nextProject = projects[nextIndex];

if (!project) {
  throw new Error(`Project not found for slug: ${slug}`);
}

const { Content } = await project.render();
---

<Layout title={`${project.data.title} – Simon Groiss`}>
  <main class="min-h-screen">
    <!-- Header / Intro -->
    <div
      id="project-header"
      class="md:h-[30vh] lg:h-[45vh] flex flex-col items-center justify-center"
    >
      <h1 class="text-6xl">{project.data.desc}</h1>
    </div>

    <!-- dein Entry-Overlay, unverändert -->
    <div id="project-entry-container" class="relative h-[100px]">
      <div
        id="project-entry-static"
        class="h-[100px] flex items-center justify-center"
        style={`background-color: ${project.data.overlayColor};`}
      >
        <span class="text-lg uppercase">{project.data.title}</span>
      </div>
      <div
        id="project-entry-animation"
        class="fixed h-full inset-0 flex items-center justify-center z-50 pointer-events-none"
        style={`background-color: ${project.data.overlayColor};`}
      >
        <span id="project-title" class="text-lg uppercase opacity-0">
          {project.data.title}
        </span>
      </div>
    </div>

    <!-- CONTENT aus sections[] -->
    <section id="project-content">
      {
        project.data.sections?.map((section, index) => {
          // MEDIENBLOCK (ein Bild/Video)
          if (section.type === "media") {
            const baseClasses = section.fullwidth
              ? "w-full"
              : (section.class ?? "container mx-auto ");

            return (
              <div class={baseClasses} data-section-index={index}>
                <MediaRenderer
                  media={{
                    type: section.format,
                    src: section.src,
                    alt: section.alt,
                    poster: section.poster,
                  }}
                  fallbackAlt={project.data.title}
                  class="w-full object-cover"
                />
              </div>
            );
          }

          // MEDIA-GROUP (z.B. 2 Bilder im Grid)
          if (section.type === "media-group") {
            const cols =
              section.layout === "3col" ? "grid-cols-3" : "grid-cols-2";
            const gap = section.gap ?? "gap-4";

            return (
              <div
                class={`container mx-auto grid ${cols} ${gap}`}
                data-section-index={index}
              >
                {section.items.map((item, itemIndex) => (
                  <MediaRenderer
                    media={{
                      type: item.format,
                      src: item.src,
                      alt: item.alt,
                      poster: item.poster,
                    }}
                    fallbackAlt={project.data.title}
                    class={item.class ?? "w-full object-cover"}
                    data-item-index={itemIndex}
                  />
                ))}
              </div>
            );
          }

          // TEXTBLOCK
          if (section.type === "text") {
            return (
              <div
                class="container mx-auto px-[20vw]!"
                data-section-index={index}
              >
                <h2 class="text-4xl dm-sans font-normal mb-2">
                  {section.title}
                </h2>
                <p class="text-lg">{section.body}</p>
              </div>
            );
          }

          // SPACER
          if (section.type === "spacer") {
            const pad = section.size ?? "py-20";
            return <div class={pad} data-section-index={index} />;
          }

          return null;
        })
      }
    </section>
  </main>

  {
    nextProject && (
      <a
        href={`/projects/${nextProject.slug}`}
        class="block"
        onclick="sessionStorage.setItem('internalRef','1')"
      >
        <div
          class="py-32 bg-sg-light-black flex items-center justify-center transition-colors duration-300 next-project-teaser"
          style={`--next-overlay-color: ${nextProject.data.overlayColor ?? "#ff0000"}`}
        >
          <span class="uppercase tracking-wide text-lg">
            Zum nächsten Projekt:&nbsp;{nextProject.data.title}
          </span>
        </div>
      </a>
    )
  }
</Layout>

<script>
  import "../../scripts/main.js";
  import "../../scripts/project-entry.js";
</script>
